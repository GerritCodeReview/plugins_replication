{
  "comments": [
    {
      "key": {
        "uuid": "7333e9ad_55a56e41",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 42,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-01T13:52:01Z",
      "side": 1,
      "message": "Can we document here the state transitions which happen during the start i.e.:\n\n  NOT_RUNNING \u003e REPLYING (and RUNNING) \u003e RUNNING\n\nespecially the \"replying and running\" state needs to be explained and differentiated\nfrom the pure running state IMHO.\n\nI feel like we will not be able to follow this code a couple of months from now.",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f0979999_0f0f6e02",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 42,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2019-10-02T12:24:05Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7333e9ad_55a56e41",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "70ede0de_9474ba27",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 137,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-25T20:18:18Z",
      "side": 1,
      "message": "Needs to be synchronized.",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9e268f70_3365b5d9",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 137,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2019-09-25T21:25:59Z",
      "side": 1,
      "message": "It\u0027s a synchronized set so all the operations are thread safe we need to use synchronized block only for iteration:\nhttps://docs.oracle.com/javase/7/docs/api/java/util/Collections.html#synchronizedSet(java.util.Set)\n\nMore detailed explanation:\nhttps://www.baeldung.com/java-synchronized-collections\n\nSynchronized collections achieve thread-safety through intrinsic locking, and the entire collections are locked. Intrinsic locking is implemented via synchronized blocks within the wrapped collection\u0027s methods.\n\nAs we might expect, synchronized collections assure data consistency/integrity in multi-threaded environments. However, they might come with a penalty in performance, as only one single thread can access the collection at a time (a.k.a. synchronized access).",
      "parentUuid": "70ede0de_9474ba27",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8502e449_57ef71cb",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 137,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-25T21:36:16Z",
      "side": 1,
      "message": "Thanks for the detailed explanation, however, I believe you wanted to make sure that you don\u0027t fire events at the same time that you\u0027re receiving them.\n\nThe running variable isn\u0027t protected any synchronization, so that makes technically possible that you are adding and replaying events at the same time.\n\nBest to be safe than sorry, and use a traditional synchronized on the variable IMHO.",
      "parentUuid": "9e268f70_3365b5d9",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c4c6d86d_3a7af3a1",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 137,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2019-09-25T21:57:19Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8502e449_57ef71cb",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "895bcfdc_14fa1d8f",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 137,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-01T13:52:01Z",
      "side": 1,
      "message": "\u003e The running variable isn\u0027t protected any synchronization, so that makes technically possible that you are adding and replaying events at the same time.\n\nThe code and dependencies look quite convoluted to me. My understanding it that:\n\n  replying \u003d true\n\ncan only happen when:\n\n  running \u003d true\n\nbecause firePendingEvents, where replying is set to true, is called after running is set\nto true (lines 79-80). Adding events can only happen when running \u003d false, but at this\ntime the replying is also false.",
      "parentUuid": "c4c6d86d_3a7af3a1",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3f727277_a3efebb1",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 186,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-01T13:52:01Z",
      "side": 1,
      "message": "Why is this logic not a part of the firePendingEvents? We need to replay all events,\nthe persisted ones and those which happened just before the queue started fully i.e.\nuntil running was false. Why not keep everything within the same try-finally block\nwhich handles the replying flag?",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c7372814_6f83a7df",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 186,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2019-10-02T12:24:05Z",
      "side": 1,
      "message": "I\u0027m not sure if we want to mix two types of events, those two methods have two different behaviour one is blocking and one is not. I agree that we could have one single method which is calling both firePendingEvents and fireBeforeStartupEvents to make sure that we are always doing full replay but I would do it in a following change",
      "parentUuid": "3f727277_a3efebb1",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3cf13369_d60fcfcb",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 187,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-25T21:36:16Z",
      "side": 1,
      "message": "This is blocking on the collection object, however, it would require that you are putting a synchronizad(beforeStartupEventsSet) also at L137",
      "range": {
        "startLine": 187,
        "startChar": 4,
        "endLine": 187,
        "endChar": 41
      },
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "172c5801_d0c6d33a",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 187,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2019-09-25T21:57:19Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3cf13369_d60fcfcb",
      "range": {
        "startLine": 187,
        "startChar": 4,
        "endLine": 187,
        "endChar": 41
      },
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "24814dae_c39774a0",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 193,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-25T20:18:18Z",
      "side": 1,
      "message": "We do we need this?",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4e86ca3b_af35f798",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 193,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2019-09-25T21:25:59Z",
      "side": 1,
      "message": "we have to remove events from the Set when we schedule them, we can do it in that way or after iteration we can do beforeStartupEventsSet.clean(). Second option is all or nothing, currently we are removing events one by one when they are processed",
      "parentUuid": "24814dae_c39774a0",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4706245e_08064450",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 2
      },
      "lineNbr": 193,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-25T21:36:16Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "4e86ca3b_af35f798",
      "revId": "c106a0afddcfdaebf9b99fcfb3380c1aac98cf9d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}