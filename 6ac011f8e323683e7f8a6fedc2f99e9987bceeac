{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "98aa3eca_0766b317",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-11T21:35:19Z",
      "side": 1,
      "message": "I can\u0027t tell why verification on CI fails as it doesn\u0027t show any info but `-1` for me and it passes locally :/",
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fa238ec4_176739e0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-10-11T21:46:58Z",
      "side": 1,
      "message": "I see two issues with the Zuul build:\n\n\u003e openjdk full version \"1.8.0_302-8u302-b08-1~deb9u1-b08\"\nWhy is this using Java 8? We are building with Java 11 on master.\n\n\u003e 2021/10/11 21:37:51 Downloading https://releases.bazel.build/4.0.0/release/bazel-4.0.0-linux-x86_64...\nWhy is this using Bazel 4.0? We are using 4.2 now.",
      "parentUuid": "98aa3eca_0766b317",
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ec32a730_e912e68c",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 579,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-13T17:05:50Z",
      "side": 1,
      "message": "If you\u0027re not re-running generateUpdates() for each batch, aren\u0027t you trusting that the updates you generated earlier are still valid? That seems like it defeats the point of a lot of the code in generateUpdates(). It\u0027s intended to be per-push. If you do multiple pushes, I think you need to call generateUpdates for each one.",
      "range": {
        "startLine": 579,
        "startChar": 58,
        "endLine": 579,
        "endChar": 62
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "17e40f2e_5e1a9a43",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 579,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-19T07:49:13Z",
      "side": 1,
      "message": "I would agree if there was a chance that other thread was pushing to the same repo in the same time - which is not. IMHO there is the same chance that big push fails or any of batches fails if 3rd party updates the repo in question in the same time. However this is not the case that we want to solve (at least not yet ;)) as that would be: ensure that push works even if the remote was updated in the meantime ;)",
      "parentUuid": "ec32a730_e912e68c",
      "range": {
        "startLine": 579,
        "startChar": 58,
        "endLine": 579,
        "endChar": 62
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5862bd59_c2dff048",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 579,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-19T20:30:57Z",
      "side": 1,
      "message": "\u003e I would agree if there was a chance that other thread was pushing to the same repo in the same time - which is not. IMHO there is the same chance that big push fails or any of batches fails if 3rd party updates the repo in question in the same time.\n\nI don\u0027t think we should assume remotes (or the local repos) are only being updated by us. That may be the case for some setups, but certainly not all. For example, multi-primary clusters could update same repo from multiple processes and as you mention, some non-Gerrit process could make updates. The replication plugin doesn\u0027t currently make the assumption that it\u0027s the only writer and I\u0027m not comfortable with adding that assumption.\n\n\u003e However this is not the case that we want to solve (at least not yet ;)) as that would be: ensure that push works even if the remote was updated in the meantime ;)\n\nThat case is already handled by retries and retries do re-run generateUpdates().",
      "parentUuid": "17e40f2e_5e1a9a43",
      "range": {
        "startLine": 579,
        "startChar": 58,
        "endLine": 579,
        "endChar": 62
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0e7de6cb_80a0300d",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 579,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-20T07:21:55Z",
      "side": 1,
      "message": "So to sum it up: I\u0027m slightly improving this aspect (as smaller/faster pushes are more likely to succeed) but also not making it worse, correct?",
      "parentUuid": "5862bd59_c2dff048",
      "range": {
        "startLine": 579,
        "startChar": 58,
        "endLine": 579,
        "endChar": 62
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9ede9e69_1c78624b",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 591,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-13T17:05:50Z",
      "side": 1,
      "message": "do we know it was actually completed or could it have failed?",
      "range": {
        "startLine": 591,
        "startChar": 62,
        "endLine": 591,
        "endChar": 71
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9a5c13d5_6f29e3f6",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 591,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-19T07:49:13Z",
      "side": 1,
      "message": "It is the same way we know if single push completed ;) IMHO it either was completed or exception was thrown and this code will not be reached.",
      "parentUuid": "9ede9e69_1c78624b",
      "range": {
        "startLine": 591,
        "startChar": 62,
        "endLine": 591,
        "endChar": 71
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fc028dbf_effc736a",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 591,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-19T20:30:57Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "9a5c13d5_6f29e3f6",
      "range": {
        "startLine": 591,
        "startChar": 62,
        "endLine": 591,
        "endChar": 71
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "747b333f_ed1c8b97",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 636,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-13T17:05:50Z",
      "side": 1,
      "message": "Since you mentioned generateUpdates was expensive, I happened to look in here and saw this. I think for many replication use cases, this is going to be doing much more than what we need. Line 653 below can probably use exactRef(src) or something like that instead. And then add an else at 657 that does this without the toMap so that we can pass a list of refs to forProject.filter().\n\n702 is looking for a key in the \u0027local\u0027 map, but we can probably find a way to do that efficiently still.\n\nIf you think improving this performance would be a pre-req to using generateUpdates() per-batch, then this should probably come first.",
      "range": {
        "startLine": 635,
        "startChar": 4,
        "endLine": 636,
        "endChar": 85
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "af504cd3_6b5c43d1",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 636,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-19T07:49:13Z",
      "side": 1,
      "message": "Nope that is not my intention. I could be wrong (so don\u0027t hesitate to correct me ;)) but AFAIR there is this replication runway optimization that groups pushes to remote. IOW if we did the batches on scheduling level it would be then again optimised to single push...",
      "parentUuid": "747b333f_ed1c8b97",
      "range": {
        "startLine": 635,
        "startChar": 4,
        "endLine": 636,
        "endChar": 85
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e08dff73_99edf2e7",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 636,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-19T20:30:57Z",
      "side": 1,
      "message": "There is that optimization and my idea for how you\u0027d add batch size support would be to limit that optimization to a certain batch size. That way the features work together.\n\nHowever, thinking about that more I\u0027m not sure how well it really works because you don\u0027t correctly know the size of the batch until you run generateUpdates. Maybe you\u0027d end up ignoring batch size until you reach the code above, then schedule a new push with anything that doesn\u0027t fit in your batch? Since this push is already in flight, it wouldn\u0027t be combined with the new one. That could really mess with scheduling priority though as the new task would be at the end of the queue.\n\nMaybe the conservative thing to do would be what you have here, but run generateUpdates for each push/batch? I don\u0027t love that either. Maybe see if others have ideas?\n\nIndependent of your change, I do think there\u0027s some reasonably easy optimization to be had in here, so that\u0027s nice to know if folks are seeing performance issues.",
      "parentUuid": "af504cd3_6b5c43d1",
      "range": {
        "startLine": 635,
        "startChar": 4,
        "endLine": 636,
        "endChar": 85
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "233060d4_c3a51df8",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 636,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-20T07:21:55Z",
      "side": 1,
      "message": "Fully agree with:\n\n\u003eIndependent of your change, I do think there\u0027s some reasonably easy optimization to be had in here, so that\u0027s nice to know if folks are seeing performance issues.\n\nand I can tackle it once we are over this one ;)",
      "parentUuid": "e08dff73_99edf2e7",
      "range": {
        "startLine": 635,
        "startChar": 4,
        "endLine": 636,
        "endChar": 85
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "36da48f1_b09b37fb",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 879,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-13T17:05:50Z",
      "side": 1,
      "message": "You can move this to 876 I think. I find it easier to read a class when default initialization is done before the constructor.",
      "range": {
        "startLine": 879,
        "startChar": 21,
        "endLine": 879,
        "endChar": 38
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c3a0c7d9_dd12dcab",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 879,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-19T07:49:13Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "36da48f1_b09b37fb",
      "range": {
        "startLine": 879,
        "startChar": 21,
        "endLine": 879,
        "endChar": 38
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "91391589_bee7d361",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 879,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-10-19T20:30:57Z",
      "side": 1,
      "message": "Not done in PS5?",
      "parentUuid": "c3a0c7d9_dd12dcab",
      "range": {
        "startLine": 879,
        "startChar": 21,
        "endLine": 879,
        "endChar": 38
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8d77166e_ee1c7694",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushOne.java",
        "patchSetId": 4
      },
      "lineNbr": 879,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-10-20T07:21:55Z",
      "side": 1,
      "message": "Sorry about that - was switching between branches and lost this change :/",
      "parentUuid": "91391589_bee7d361",
      "range": {
        "startLine": 879,
        "startChar": 21,
        "endLine": 879,
        "endChar": 38
      },
      "revId": "6ac011f8e323683e7f8a6fedc2f99e9987bceeac",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}