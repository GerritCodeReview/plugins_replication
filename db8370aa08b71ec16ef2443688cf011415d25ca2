{
  "comments": [
    {
      "key": {
        "uuid": "7e109c95_03c4ee82",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 11,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2013-10-18T12:36:26Z",
      "side": 1,
      "message": "From what I see in your code the ref-replicated and ref-replication-done events will NOT be sent when the replication is triggered from the \"start\" command of the replication plugin i.e.:\n\n  $ ssh me@gerrit replication start --all\n\nThe reason is that in that case the ReplicationState will use a CommandProcessing instance instead of a GitUpdateProcessing instance (where your event streaming happens).\n\nIs this behavior intentional? Do you also want to stream events done from the \"start\" command?",
      "revId": "db8370aa08b71ec16ef2443688cf011415d25ca2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "be16948d_c545ba4b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 11,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2013-10-18T13:59:17Z",
      "side": 1,
      "message": "Yes, I only intended to send events for replication cause by a reference updated for now. I see the need to get stream events for any cause of replication (start up or command) but I will do that later on. I updated the commit message to be more clear.",
      "parentUuid": "7e109c95_03c4ee82",
      "revId": "db8370aa08b71ec16ef2443688cf011415d25ca2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7e109c95_63b9620b",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushResultProcessing.java",
        "patchSetId": 3
      },
      "lineNbr": 161,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2013-10-18T12:36:26Z",
      "side": 1,
      "message": "I was thinking that after c573d8abf66ccf21187defcd4818e85892a9507d we can rely on the totalPushTaskCount as one event will be fired for one ref. Why do you still need the replicationCount?\n\nOn the other hand, I am not sure if you want to stream events for replications triggered from the \"start\" command (see my comment on the commit message). If yes, then even the assumption that one instance of the ReplicationState will be used to process one RefUpdate event is not true any more. The \"start --all\" will trigger replication of all repositories and all refs and will use one single ReplicationState instance for scheduled replication tasks. Since one ReplicationState instance contains exactly one PushResultProcessing instance, the onOneNodeReplicated would be called with different (project, ref, uri, ..) values. This will not happen with the GitUpdateProcessing instances so this implementation is OK. However, we should keep this fact in mind if we are going to support event streaming for the replications triggered from the \"start\" command (this support would be done into the CommandProcessing class above).",
      "revId": "db8370aa08b71ec16ef2443688cf011415d25ca2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3ed0e40e_81be3af2",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushResultProcessing.java",
        "patchSetId": 3
      },
      "lineNbr": 161,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2013-10-18T13:34:00Z",
      "side": 1,
      "message": "I see you uploaded a new patch-set but I don\u0027t know your opinion about what I wrote above? Do you agree/disagree?",
      "parentUuid": "7e109c95_63b9620b",
      "revId": "db8370aa08b71ec16ef2443688cf011415d25ca2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1ed5e0ff_4060aedb",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushResultProcessing.java",
        "patchSetId": 3
      },
      "lineNbr": 161,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2013-10-18T13:59:17Z",
      "side": 1,
      "message": "It simplified the code because we no longer need to keep a map of ref updated and I think you are right, we could rely on the totalPushTasksCount for the GitUpdateProcessing. As I said in my comment in the commit message, I think we will need replication event for command and the implementation in the CommandProcessing will need to handle the fact that onOneNodeReplicated will get called for more than one project/ref.",
      "parentUuid": "7e109c95_63b9620b",
      "revId": "db8370aa08b71ec16ef2443688cf011415d25ca2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7e109c95_c3a936ba",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushResultProcessing.java",
        "patchSetId": 3
      },
      "lineNbr": 161,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2013-10-18T14:12:53Z",
      "side": 1,
      "message": "I am also fine with supporting the other causes of replication later.\n\nWhat I already see is that the implementation in the CommandProcessing will be quite similar to this one but a bit more complex. Maybe the complexity could be reduced by introducing yet another callback method in the PushResultProcessing:\n\n  void onOneRefReplicated(String project, String ref, int totalPushTasksCount)\n\nwhich would be invoked when one ref is replicated to all replication targets. Having a callback like this would simplify both this change and\nthe future change that would support streaming of events when the replication is triggered from the \"start\" command. I will check on Monday how easy/hard it would be to add this new callback. However, this change doesn\u0027t have to wait... if you fix the remaining issues we can submit it and then later simplify this code if/when the new callback is available.",
      "parentUuid": "1ed5e0ff_4060aedb",
      "revId": "db8370aa08b71ec16ef2443688cf011415d25ca2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "be16948d_a597de92",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/PushResultProcessing.java",
        "patchSetId": 3
      },
      "lineNbr": 161,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2013-10-18T14:43:45Z",
      "side": 1,
      "message": "This new callback would be great, It would easy to implement the stream event for command, lets me know how it goes.",
      "parentUuid": "7e109c95_c3a936ba",
      "revId": "db8370aa08b71ec16ef2443688cf011415d25ca2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}