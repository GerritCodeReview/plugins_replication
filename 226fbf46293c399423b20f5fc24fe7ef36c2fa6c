{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "3d47ab28_65701195",
        "filename": "/COMMIT_MSG",
        "patchSetId": 8
      },
      "lineNbr": 13,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-03-02T00:34:32Z",
      "side": 1,
      "message": "Why is this needed? If the security policies impose the use of an encrypted storage, the use of the plaintext password on the remote is a security threat.",
      "range": {
        "startLine": 11,
        "startChar": 37,
        "endLine": 13,
        "endChar": 26
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "99f31f6b_3b0a8b4e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 8
      },
      "lineNbr": 13,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-03-02T08:59:10Z",
      "side": 1,
      "message": "the `replication` plugin was accessing `secure.config` directly, without any encryption, which means that existing installations will have secrets stored there in plain text, even if the encrypted secure store was enabled. Without that fallback mechanism, we\u0027d need a migration step that will encrypt everything in `secure.config`.",
      "parentUuid": "3d47ab28_65701195",
      "range": {
        "startLine": 11,
        "startChar": 37,
        "endLine": 13,
        "endChar": 26
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ffd19efd_6149f921",
        "filename": "/COMMIT_MSG",
        "patchSetId": 8
      },
      "lineNbr": 13,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-03-02T11:24:51Z",
      "side": 1,
      "message": "\u003e the `replication` plugin was accessing `secure.config` directly, without any encryption, which means that existing installations will have secrets stored there in plain text, even if the encrypted secure store was enabled.\n\nNo, Gerrit will encrypt them either during the init phase, using the passwd program or the switch-secure-store utility.\n\n\u003e Without that fallback mechanism, we\u0027d need a migration step that will encrypt everything in `secure.config`.\n\nHave you tried switch-secure-store site program? It was written by a passionate ðŸ˜Ž Gerrit contributor 10 years ago https://gerrit-review.googlesource.com/c/gerrit/+/65104.\n\nIt works as expected.",
      "parentUuid": "99f31f6b_3b0a8b4e",
      "range": {
        "startLine": 11,
        "startChar": 37,
        "endLine": 13,
        "endChar": 26
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "124933dc_6ae0e287",
        "filename": "/COMMIT_MSG",
        "patchSetId": 8
      },
      "lineNbr": 13,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-03-04T09:43:58Z",
      "side": 1,
      "message": "\u003e No, Gerrit will encrypt them either during the init phase, using the passwd program or the switch-secure-store utility.\n\nReally? How then, does the replication plugin handle the encrypted value? From what I can tell from the code it won\u0027t as it reads the `secure.config` as it\u0027s a plain text file:\n\n```java\n    FileBasedConfig cfg \u003d new FileBasedConfig(site.secure_config.toFile(), FS.DETECTED);\n    if (cfg.getFile().exists() \u0026\u0026 cfg.getFile().length() \u003e 0) {\n      try {\n        cfg.load();\n```\n\nThe above is a snipped from the old `SecureCredentialsFactory` that now will use the SecureStore.\n\nMy point here is that to make the replication work, the password for the remote must be put into `secure.config` in plain text, otherwise when it\u0027s encrypted, `replication` will use that value as as a password without attempting to decrypt it.\n\nWhen we change that behaviour, we either:\n1. need to document the migration step (aka usage of `switch-secure-store` or,\n2. fallback to reading the password as plain text\n\nIf we go with #1, since 3.10, it won\u0027t be possible to drop a new `replication.jar` into `plugins/` as the passwords need to be encrypted.\n\nWith #2 we keep the same upgrade procedure, but still can support fully encrypted `secure.config`.\n\n\u003e Have you tried switch-secure-store site program?\n\nIt was a long time ago, and AFAIR was implemented during one of the hackathons at Google ;) \n\nBut this won\u0027t _magically_ migrate the `secure.config` as it must be manually executed by the Gerrit admin.",
      "parentUuid": "ffd19efd_6149f921",
      "range": {
        "startLine": 11,
        "startChar": 37,
        "endLine": 13,
        "endChar": 26
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "85a0ddb3_cc4f9037",
        "filename": "/COMMIT_MSG",
        "patchSetId": 8
      },
      "lineNbr": 13,
      "author": {
        "id": 1090261
      },
      "writtenOn": "2024-03-11T11:12:25Z",
      "side": 1,
      "message": "The replication plugin does not ask in the init step for passwords. This is all handled by hand. Additionally, the passwd command does not know how to encrypt items with subsections, which is what is used in the replication plugin. \nSee https://issues.gerritcodereview.com/issues/321784728\nThe switch-secure-store works when there is the need to do the transition from plain to encrypted of all the information, not when there is already a hybrid of secure/non secure data in the secure.config. The fallback strategy aims to allow a way to still read the plain text data, if encountered.",
      "parentUuid": "124933dc_6ae0e287",
      "range": {
        "startLine": 11,
        "startChar": 37,
        "endLine": 13,
        "endChar": 26
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "941e9ee0_3c692079",
        "filename": "/COMMIT_MSG",
        "patchSetId": 8
      },
      "lineNbr": 13,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-03-19T23:49:04Z",
      "side": 1,
      "message": "\u003e The replication plugin does not ask in the init step for passwords.\n\nTrue, that\u0027s because it does not ask for replication configs during init.\n\n\u003e This is all handled by hand.\n\nYep, the Gerrit admin is supposed to be capable of managing config files.\n\n\u003e Additionally, the passwd command does not know how to encrypt items with subsections, which is what is used in the replication plugin. \n\u003e See https://issues.gerritcodereview.com/issues/321784728\n\nPoint taken, the above issue needs to be sorted out *before* this change can be merged.\n\n\u003e The switch-secure-store works when there is the need to do the transition from plain to encrypted of all the information, not when there is already a hybrid of secure/non secure data in the secure.config. The fallback strategy aims to allow a way to still read the plain text data, if encountered.\n\nIMHO the fallback mechanism is a security risk: if you decide to go with the encrypted secure.config, it must be *all encrypted*. The Gerrit admin has to sort this out.",
      "parentUuid": "85a0ddb3_cc4f9037",
      "range": {
        "startLine": 11,
        "startChar": 37,
        "endLine": 13,
        "endChar": 26
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4e5c9d98_cf4a722a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 8
      },
      "lineNbr": 13,
      "author": {
        "id": 1090261
      },
      "writtenOn": "2024-03-20T09:29:44Z",
      "side": 1,
      "message": "\u003e \u003e The replication plugin does not ask in the init step for passwords.\n\u003e \n\u003e True, that\u0027s because it does not ask for replication configs during init.\n\u003e \n\u003e \u003e This is all handled by hand.\n\u003e \n\u003e Yep, the Gerrit admin is supposed to be capable of managing config files.\n\u003e \n\u003e \u003e Additionally, the passwd command does not know how to encrypt items with subsections, which is what is used in the replication plugin. \n\u003e \u003e See https://issues.gerritcodereview.com/issues/321784728\n\u003e \n\u003e Point taken, the above issue needs to be sorted out *before* this change can be merged.\n\u003e \n\u003e \u003e The switch-secure-store works when there is the need to do the transition from plain to encrypted of all the information, not when there is already a hybrid of secure/non secure data in the secure.config. The fallback strategy aims to allow a way to still read the plain text data, if encountered.\n\u003e \n\u003e IMHO the fallback mechanism is a security risk: if you decide to go with the encrypted secure.config, it must be *all encrypted*. The Gerrit admin has to sort this out.\n\nIn that case I suggest that we continue raising the exception if the secure.config is used with plain text and if the users want to use plain text for the replication together with the secure-config plugin, then they need to use the parameters in the replication.config, as now implemented.",
      "parentUuid": "941e9ee0_3c692079",
      "range": {
        "startLine": 11,
        "startChar": 37,
        "endLine": 13,
        "endChar": 26
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2dc555b3_937018be",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 8
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-03-19T23:49:04Z",
      "side": 1,
      "message": "IMHO this is blocked by Issue 321784728: we need first to enable the Gerrit admin to set the replication passwords using the passwd program.",
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "992223b9_01977583",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 8
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-06-13T17:05:41Z",
      "side": 1,
      "message": "I believe this is the wrong solution: it must be a lot simpler and reduce the impact with the current code.\n\nI\u0027ve attempted an easier solution with Ie5b6339d65d that only touches the reading of the file and replace it with the SecureStore.",
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "47d927b5_77db62e4",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/RemoteConfiguration.java",
        "patchSetId": 8
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-03-02T00:34:32Z",
      "side": 1,
      "message": "Nit: unrelated formatting changes across the file.",
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cdb30fb1_b2a341ac",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/RemoteConfiguration.java",
        "patchSetId": 8
      },
      "lineNbr": 139,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-03-02T00:34:32Z",
      "side": 1,
      "message": "Why do we need this? Can you elaborate?",
      "range": {
        "startLine": 123,
        "startChar": 0,
        "endLine": 139,
        "endChar": 0
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9ae66374_5863e495",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/RemoteConfiguration.java",
        "patchSetId": 8
      },
      "lineNbr": 139,
      "author": {
        "id": 1090261
      },
      "writtenOn": "2024-03-11T11:12:25Z",
      "side": 1,
      "message": "During the previous comments, it was mentioned in the #46, the following:\n\nTake it from replication.config (2nd) if not found in the credentials\n\nAs of now, the replication.config does not support having properties for username and password, as it depended solely on the secure.config. This code is needed to support the property read in the replication.config.",
      "parentUuid": "cdb30fb1_b2a341ac",
      "range": {
        "startLine": 123,
        "startChar": 0,
        "endLine": 139,
        "endChar": 0
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "498b7f2d_1caaf193",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/SecureCredentialsFactory.java",
        "patchSetId": 8
      },
      "lineNbr": 89,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-06-13T17:05:41Z",
      "side": 1,
      "message": "There isn\u0027t any change in the way the configuration is stored on the filesystem, we just use the proper API instead of reading the file directly. We do not need this fallback at all.",
      "range": {
        "startLine": 80,
        "startChar": 0,
        "endLine": 89,
        "endChar": 7
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "25eafbe7_806ad2e3",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/SecureCredentialsFactory.java",
        "patchSetId": 8
      },
      "lineNbr": 132,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-06-13T17:05:41Z",
      "side": 1,
      "message": "This is unneeded.",
      "range": {
        "startLine": 103,
        "startChar": 0,
        "endLine": 132,
        "endChar": 3
      },
      "revId": "226fbf46293c399423b20f5fc24fe7ef36c2fa6c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}