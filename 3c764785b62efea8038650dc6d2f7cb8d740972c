{
  "comments": [
    {
      "key": {
        "uuid": "bfc24ad9_6d2cfaac",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 8
      },
      "lineNbr": 0,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2020-08-19T22:56:40Z",
      "side": 1,
      "message": "Any reason this shouldn\u0027t get submitted?",
      "revId": "3c764785b62efea8038650dc6d2f7cb8d740972c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e186ffa4_3cc38ade",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 8
      },
      "lineNbr": 0,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2020-08-19T23:47:54Z",
      "side": 1,
      "message": "Was this tested to see if it solves the bug?",
      "revId": "3c764785b62efea8038650dc6d2f7cb8d740972c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fd1b8145_0682ee36",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 102,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2020-08-19T23:54:09Z",
      "side": 1,
      "message": "FYI, be aware that when attempting to merge this to 3.1 it will likely allow the server to startup, but then still hold up the replication plugin from doing anything because almost all the methods in the ReplicationTasksStorage class are synchronized. In particular list() is synchronized which means that this thread will then hold a lock on that Class until it is done.",
      "range": {
        "startLine": 102,
        "startChar": 34,
        "endLine": 102,
        "endChar": 51
      },
      "revId": "3c764785b62efea8038650dc6d2f7cb8d740972c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "72689512_2dc28ec4",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 102,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2020-08-20T11:41:03Z",
      "side": 1,
      "message": "The ReplicationTaskStorage has no synchronization in stable-2.16.\nAs I see, synchronization is introduced in stable-3.1 in this [1] change.\nI don\u0027t know if synchronization was the only way to resolve the issues\nlisted in the commit message of [1]. Luca?\n\nBtw, your change [2] you introduces another method for fetching all stored\ntasks: streamWaiting, which is not synchronized. Considering that most of\nother methods are synchronized we need to understand how does this relate\nto the issues described in the commit message of [1].\n\n[1] https://gerrit-review.googlesource.com/c/plugins/replication/+/247792\n[2] https://gerrit-review.googlesource.com/c/plugins/replication/+/267812",
      "parentUuid": "fd1b8145_0682ee36",
      "range": {
        "startLine": 102,
        "startChar": 34,
        "endLine": 102,
        "endChar": 51
      },
      "revId": "3c764785b62efea8038650dc6d2f7cb8d740972c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "42e0198d_c7827c0f",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 102,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-08-20T12:14:30Z",
      "side": 1,
      "message": "\u003e The ReplicationTaskStorage has no synchronization in stable-2.16.\n\u003e As I see, synchronization is introduced in stable-3.1 in this [1] change.\n\u003e I don\u0027t know if synchronization was the only way to resolve the issues\n\u003e listed in the commit message of [1]. Luca?\n\n[1] was mainly directed for having a \"stabla picture\" when you list the replication tasks on the filesystem. You need to block the modifications during the listing, otherwise the results are unpredictable.\n\nIt is true that during the listing we would not allow further additions to the replication queue, however, that should take fractions of seconds and, as Saša said, isn\u0027t blocking Gerrit startup anyway.\n\nThe headline of this change is \"Don\u0027t wait for pending event to process ...\" and I believe that the concern of this change in this branch is addressed.\n\nFor further improvements on other branches, we are likely to require further changes *IF* the listing is a matter of concern for your guys, if you are in a stable-3.x branch in production.",
      "parentUuid": "72689512_2dc28ec4",
      "range": {
        "startLine": 102,
        "startChar": 34,
        "endLine": 102,
        "endChar": 51
      },
      "revId": "3c764785b62efea8038650dc6d2f7cb8d740972c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d4af84e2_78b002b7",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/ReplicationQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 102,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2020-08-20T14:02:55Z",
      "side": 1,
      "message": "\u003e \u003e The ReplicationTaskStorage has no synchronization in stable-2.16.\n\u003e \u003e As I see, synchronization is introduced in stable-3.1 in this [1] change.\n\u003e \u003e I don\u0027t know if synchronization was the only way to resolve the issues\n\u003e \u003e listed in the commit message of [1]. Luca?\n\u003e \n\u003e [1] was mainly directed for having a \"stabla picture\" when you list the replication tasks on the filesystem. You need to block the modifications during the listing, otherwise the results are unpredictable.\n\nI would support on alternative fix as this was for testing support only I believe.\n\n\u003e It is true that during the listing we would not allow further additions to the replication queue, however, that should take fractions of seconds and,\n\nI don\u0027t believe that seconds is the case on a busy server with 100K events on NFS.\n\n\u003e as Saša said, isn\u0027t blocking Gerrit startup anyway.\n\nAgreed, however it would be a new regression to block replication (instead of server startup), so this should not be merged to 3.1 if it causes a regression. \n\n\u003e The headline of this change is \"Don\u0027t wait for pending event to process ...\" and I believe that the concern of this change in this branch is addressed.\n\nI don\u0027t think the headline is relevant when considering the merge to 3.1.\n\n\u003e For further improvements on other branches, we are likely to require further changes *IF* the listing is a matter of concern for your guys, if you are in a stable-3.x branch in production.\n\nI believe that the \u0027regression listing\" synchronized regression needs to be prevented  before merging this to 3.1.",
      "parentUuid": "42e0198d_c7827c0f",
      "range": {
        "startLine": 102,
        "startChar": 34,
        "endLine": 102,
        "endChar": 51
      },
      "revId": "3c764785b62efea8038650dc6d2f7cb8d740972c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}